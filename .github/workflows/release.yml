name: Cross-Platform Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.0.1, etc.
  workflow_dispatch:  # Allow manual trigger from GitHub Actions tab

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          python -m unittest tests.test_basic -v

  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build executable
        run: |
          cd ${{ github.workspace }}
          python -m PyInstaller --clean "${{ github.workspace }}/SpeedReader.spec"

      - name: Build Python packages
        run: |
          python setup.py sdist bdist_wheel

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: dist/SpeedReader.exe

  build-macos:
    name: Build macOS App Bundle
    runs-on: macos-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build app bundle
        run: |
          cd ${{ github.workspace }}
          python -m PyInstaller --clean "${{ github.workspace }}/SpeedReader.spec"

      - name: Create DMG (optional)
        run: |
          # Create a simple dmg for distribution
          mkdir -p dmg-temp
          cp -r dist/SpeedReader.app dmg-temp/
          hdiutil create -volname "Speed Reader" -srcfolder dmg-temp -ov -format UDZO -o dist/SpeedReader.dmg
          rm -rf dmg-temp

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: |
            dist/SpeedReader.app
            dist/SpeedReader.dmg

  build-linux:
    name: Build Linux Executable
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install PyQt6 libraries
        run: |
          sudo apt-get update
          sudo apt-get install -y libqt6gui6 libqt6core6

      - name: Build executable
        run: |
          cd ${{ github.workspace }}
          python -m PyInstaller --clean "${{ github.workspace }}/SpeedReader.spec"
          chmod +x dist/SpeedReader

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: dist/SpeedReader

  build-packages:
    name: Build Python Packages
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools

      - name: Build packages
        run: |
          cd ${{ github.workspace }}
          python -m build

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-packages
          path: dist/speed_reader-*

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux, build-packages]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files
          
          # Windows
          cp release-artifacts/windows-builds/SpeedReader.exe release-files/SpeedReader-Windows.exe
          
          # macOS
          cd release-artifacts/macos-builds
          zip -r ../../release-files/SpeedReader-macOS.app.zip SpeedReader.app
          cp SpeedReader.dmg ../../release-files/SpeedReader-macOS.dmg
          cd ../../
          
          # Linux
          cp release-artifacts/linux-builds/SpeedReader release-files/SpeedReader-Linux
          
          # Python packages
          cp release-artifacts/python-packages/* release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/*
          body: |
            ## Speed Reader Release
            
            Standalone executables for all platforms:
            - **Windows**: SpeedReader-Windows.exe
            - **macOS**: SpeedReader-macOS.app.zip or SpeedReader-macOS.dmg
            - **Linux**: SpeedReader-Linux
            
            Python packages:
            - speed_reader-*.whl (wheel)
            - speed-reader-*.tar.gz (source)

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux, build-packages]
    if: always()
    steps:
      - name: Print Build Summary
        run: |
          echo "========================================="
          echo "Cross-Platform Build Summary"
          echo "========================================="
          echo "Windows:  ${{ needs.build-windows.result }}"
          echo "macOS:    ${{ needs.build-macos.result }}"
          echo "Linux:    ${{ needs.build-linux.result }}"
          echo "Packages: ${{ needs.build-packages.result }}"
          echo "========================================="
